---
import Layout from "../layouts/Layout.astro";

// Dynamic menu page - Fetches from MySQL on IONOS, falls back to LocalStorage locally
---

<Layout title="Getränkekarte">
    <main class="bg-black min-h-screen">
        <!-- Header -->
        <header
            class="py-6 border-b border-white/5 sticky top-0 bg-black z-40"
            id="menu-header"
        >
            <div
                class="max-w-4xl mx-auto px-6 flex justify-between items-center"
            >
                <a
                    href="/"
                    class="text-secondary hover:scale-110 active:scale-95 transition-all"
                    aria-label="Zurück zur Startseite"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
                        ></path>
                    </svg>
                </a>
                <h1
                    class="text-xl uppercase tracking-[0.3em] font-bold text-white"
                >
                    Getränkekarte
                </h1>
                <div class="w-6"></div>
            </div>
        </header>

        <!-- Menu Content Holder -->
        <div
            id="menu-container"
            class="py-12 px-6 max-w-4xl mx-auto min-h-[60vh]"
        >
            <div
                class="flex flex-col items-center justify-center py-32 animate-pulse"
            >
                <div
                    class="w-12 h-12 border-2 border-secondary/20 border-t-secondary rounded-none animate-spin mb-6"
                >
                </div>
                <p
                    class="text-[10px] text-gray-500 uppercase tracking-[0.4em] font-medium"
                >
                    Lade Menü...
                </p>
            </div>
        </div>

        <!-- Footer -->
        <footer
            class="pb-20 text-center border-t border-white/5 mt-12 bg-gradient-to-b from-black to-[#050505]"
        >
            <p
                class="text-[9px] text-gray-600 uppercase tracking-[0.5em] py-12 font-medium"
            >
                Café Caruso &bull; Geislingen &bull; Seit 1989
            </p>
            <div class="flex justify-center gap-2 pb-8 opacity-20">
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
            </div>
        </footer>
    </main>
</Layout>

<script>
    async function loadMenu() {
        const container = document.getElementById("menu-container");
        if (!container) return;

        try {
            // Priority 1: Primary PHP API
            let res = await fetch("/api/get-menu.php");
            let contentType = res.headers.get("content-type");

            if (contentType && contentType.includes("application/json")) {
                const data = await res.json();
                if (Array.isArray(data) && data.length > 0) {
                    renderMenu(container, data);
                    localStorage.setItem(
                        "caruso_menu_cache",
                        JSON.stringify(data)
                    );
                    return;
                }
            }

            // Priority 2: LocalStorage (Preferred Fallback)
            const cached = localStorage.getItem("caruso_menu_cache");
            if (cached) {
                const cachedData = JSON.parse(cached);
                if (Array.isArray(cachedData) && cachedData.length > 0) {
                    renderMenu(container, cachedData);
                    return;
                }
            }

            // Priority 3: Static menu.json
            let staticRes = await fetch("/api/menu.json");
            if (staticRes.ok) {
                const staticData = await staticRes.json();
                if (Array.isArray(staticData) && staticData.length > 0) {
                    renderMenu(container, staticData);
                    return;
                }
            }

            // Hard Fallback: Mock Data
            renderMenuFromMock(container);
        } catch (err) {
            console.warn("Menu load failed, trying cache.", err);
            const cached = localStorage.getItem("caruso_menu_cache");
            if (cached) {
                renderMenu(container, JSON.parse(cached));
            } else {
                renderMenuFromMock(container);
            }
        }
    }

    function renderMenuFromMock(container: HTMLElement) {
        const mockData = [
            {
                name: "Biere",
                is_special: false,
                bg_color: "#000000",
                items: [
                    {
                        name: "Halbe",
                        price: 3.9,
                        unit: "0,5l",
                        info: "Frisch vom Fass",
                    },
                    { name: "Hefeweizen", price: 3.9, unit: "0,5l", info: "" },
                ],
            },
            {
                name: "Cocktails",
                is_special: true,
                bg_color: "#ffe08a",
                items: [
                    {
                        name: "Caipirinha",
                        price: 7.9,
                        unit: "0,4l",
                        info: "Pitu, Rohrzucker, Limette",
                    },
                ],
            },
        ];
        renderMenu(container, mockData);
    }

    function renderMenu(container: HTMLElement, data: any[]) {
        container.innerHTML = "";

        data.forEach((category, catIdx) => {
            const isSpecial = !!category.is_special;
            const bgColor =
                category.bg_color || (isSpecial ? "#ffe08a" : "#000000");

            const section = document.createElement("div");
            section.className =
                "category-section mb-16 last:mb-0 transition-all duration-700 opacity-0 transform translate-y-8";
            section.style.animationDelay = catIdx * 0.15 + "s";

            if (bgColor !== "#000000" || isSpecial) {
                section.classList.add(
                    "p-6",
                    "md:p-10",
                    "rounded-none",
                    "border-l-4",
                    "transition-all",
                    "duration-500"
                );

                // Subtle glass background
                section.style.backgroundColor = bgColor + "10";
                section.style.borderColor = bgColor;

                // Modern glow effect (removed blur/glow as requested)
                section.style.boxShadow = `none`;
            }

            let headerHtml = `
                <div class="flex items-center gap-6 mb-8">
                    <h2 class="text-2xl md:text-4xl font-bold uppercase tracking-tighter italic ${
                        isSpecial ? "text-secondary" : "text-white"
                    }">
                        ${category.name}
                    </h2>
                    ${
                        isSpecial
                            ? '<span class="bg-secondary text-black text-[9px] font-black uppercase py-1 px-3 tracking-[0.2em] rounded-none animate-pulse">Special</span>'
                            : ""
                    }
                    <div class="h-[1px] flex-grow ${
                        isSpecial ? "bg-secondary/20" : "bg-white/10"
                    }"></div>
                </div>
            `;

            let itemsHtml =
                '<div class="grid grid-cols-1 gap-y-0 text-left w-full">';
            if (category.items && Array.isArray(category.items)) {
                itemsHtml += category.items
                    .map((item: any) => {
                        const priceNum =
                            typeof item.price === "number"
                                ? item.price
                                : parseFloat(item.price);
                        const formattedPrice = priceNum
                            .toFixed(2)
                            .replace(".", ",");

                        return `
                        <div class="menu-item group flex flex-col gap-1 py-4 border-b border-white/[0.05] last:border-0 hover:bg-white/[0.01] transition-all duration-300 rounded-none">
                            <div class="flex justify-between items-baseline gap-4">
                                <h3 class="text-white text-base font-bold group-hover:text-secondary transition-colors uppercase tracking-wider">${
                                    item.name
                                }</h3>
                                <div class="flex items-baseline gap-0.5 text-secondary font-black whitespace-nowrap">
                                    <span>${formattedPrice}</span>
                                    <span class="text-[10px] ml-0.5">€</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-[11px] text-gray-300 font-medium tracking-wide">
                                <span class="opacity-90">${
                                    item.info || ""
                                }</span>
                                <span class="uppercase tracking-widest text-[10px] font-bold text-gray-400">${
                                    item.unit || ""
                                }</span>
                            </div>
                        </div>
                    `;
                    })
                    .join("");
            }
            itemsHtml += "</div>";

            section.innerHTML = headerHtml + itemsHtml;
            container.appendChild(section);

            setTimeout(() => {
                section.classList.remove("opacity-0", "translate-y-8");
                section.classList.add("opacity-100", "translate-y-0");
            }, 50);
        });
    }

    // Initialize
    loadMenu();

    // Header Scroll behavior — subtle shadow only, no size change
    window.addEventListener("scroll", () => {
        const header = document.getElementById("menu-header");
        if (header) {
            if (window.scrollY > 20) {
                header.style.boxShadow = "0 4px 20px rgba(0,0,0,0.6)";
            } else {
                header.style.boxShadow = "none";
            }
        }
    });
</script>

<style is:global>
    .special-category {
        box-shadow: 0 20px 50px -20px rgba(255, 224, 138, 0.05);
    }
    .menu-item {
        position: relative;
    }
    .menu-item::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0;
        width: 0;
        height: 1px;
        background: linear-gradient(to right, #ffe08a, transparent);
        transition: width 0.4s ease;
        opacity: 0.3;
    }
    .menu-item:hover::after {
        width: 100%;
    }
</style>
