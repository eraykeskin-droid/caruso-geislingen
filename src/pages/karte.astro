---
import Layout from "../layouts/Layout.astro";

// Dynamic menu page - Fetches from MySQL on IONOS, falls back to LocalStorage locally
---

<Layout title="Getränkekarte">
    <main class="bg-black min-h-screen">
        <!-- Header -->
        <header
            class="py-6 border-b border-white/5 sticky top-0 bg-black z-40"
            id="menu-header"
        >
            <div
                class="max-w-4xl mx-auto px-6 flex justify-between items-center"
            >
                <a
                    href="/"
                    class="text-secondary hover:scale-110 active:scale-95 transition-all"
                    aria-label="Zurück zur Startseite"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
                        ></path>
                    </svg>
                </a>
                <h1
                    class="text-xl uppercase tracking-[0.3em] font-bold text-white"
                >
                    Getränkekarte
                </h1>
                <div class="w-6"></div>
            </div>
        </header>

        <!-- Menu Content Holder -->
        <div
            id="menu-container"
            class="py-12 px-6 max-w-4xl mx-auto min-h-[60vh]"
        >
            <div
                class="flex flex-col items-center justify-center py-32 animate-pulse"
            >
                <div
                    class="w-12 h-12 border-2 border-secondary/20 border-t-secondary rounded-none animate-spin mb-6"
                >
                </div>
                <p
                    class="text-[10px] text-gray-500 uppercase tracking-[0.4em] font-medium"
                >
                    Lade Menü...
                </p>
            </div>
        </div>

        <!-- Footer -->
        <footer
            class="pb-20 text-center border-t border-white/5 mt-12 bg-gradient-to-b from-black to-[#050505]"
        >
            <p
                class="text-[9px] text-gray-600 uppercase tracking-[0.5em] py-12 font-medium"
            >
                Café Caruso &bull; Geislingen &bull; Seit 1989
            </p>
            <div class="flex justify-center gap-2 pb-8 opacity-20">
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
                <div class="w-1 h-1 bg-secondary rounded-none"></div>
            </div>
        </footer>
    </main>
</Layout>

<script>
    async function loadMenu() {
        const container = document.getElementById("menu-container");
        if (!container) return;

        try {
            // Priority 1: Primary PHP API
            let res = await fetch(`/api/get-menu.php?t=${Date.now()}`);
            let contentType = res.headers.get("content-type");

            if (contentType && contentType.includes("application/json")) {
                const data = await res.json();
                if (Array.isArray(data)) {
                    // Empty array is valid (empty menu)
                    renderMenu(container, data);
                    return;
                }
            }

            // Hard Fallback: Mock Data
            renderMenuFromMock(container);
        } catch (err) {
            console.error("Menu load failed, using fallback.", err);
            renderMenuFromMock(container);
        }
    }

    function renderMenuFromMock(container: HTMLElement) {
        const mockData = [
            {
                name: "Biere",
                is_special: false,
                bg_color: "#000000",
                items: [
                    {
                        name: "Halbe",
                        price: 3.9,
                        unit: "0,5l",
                        info: "Frisch vom Fass",
                    },
                    { name: "Hefeweizen", price: 3.9, unit: "0,5l", info: "" },
                ],
            },
            {
                name: "Cocktails",
                is_special: true,
                bg_color: "#ffe08a",
                items: [
                    {
                        name: "Caipirinha",
                        price: 7.9,
                        unit: "0,4l",
                        info: "Pitu, Rohrzucker, Limette",
                    },
                ],
            },
        ];
        renderMenu(container, mockData);
    }

    function renderMenu(container: HTMLElement, data: any[]) {
        container.innerHTML = "";

        // Filter out hidden categories. Handle cases where is_hidden might be a string "1" or number 1 from the database.
        const visibleData = data.filter(
            (cat) =>
                !(
                    cat.is_hidden == 1 ||
                    cat.is_hidden === true ||
                    cat.is_hidden === "true"
                )
        );

        visibleData.forEach((category, catIdx) => {
            const isSpecial = !!category.is_special;
            const bgColor =
                category.bg_color || (isSpecial ? "#ffe08a" : "#000000");
            const subcategories = category.subcategories || [];
            const hasSubcategories = subcategories.length > 0;
            const directItems = category.items || [];

            const section = document.createElement("div");
            section.className =
                "category-section mb-16 last:mb-0 transition-all duration-700 opacity-0 transform translate-y-8";
            section.style.animationDelay = catIdx * 0.15 + "s";

            section.classList.add(
                "p-6",
                "md:p-10",
                "rounded-none",
                "border-l-4",
                "transition-all",
                "duration-500"
            );

            if (isSpecial) {
                section.style.backgroundColor = bgColor + "15";
                section.style.borderColor = bgColor;
                section.style.boxShadow = `none`;
            } else {
                section.style.backgroundColor = "rgba(255, 255, 255, 0.04)";
                section.style.borderColor = "rgba(255, 255, 255, 0.1)";
            }

            const subBgColor =
                isSpecial && bgColor !== "#000000"
                    ? bgColor
                    : isSpecial
                    ? "#ffe08a"
                    : "rgba(255, 255, 255, 0.05)";
            const subTextColor =
                (isSpecial && bgColor !== "#000000") || isSpecial
                    ? "text-black"
                    : "text-white";

            let headerHtml = `
                <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-6 mb-8">
                    <h2 class="text-2xl md:text-4xl font-bold uppercase tracking-tighter italic text-white">
                        ${category.name}
                    </h2>
                    <div class="flex items-center gap-4 w-full md:w-auto md:flex-grow">
                        ${
                            isSpecial
                                ? `<span class="bg-secondary text-black text-[9px] font-black uppercase py-1 px-3 tracking-[0.2em] rounded-none animate-pulse shrink-0">${
                                      category.badge_text || "Special"
                                  }</span>`
                                : ""
                        }
                        <div class="h-[1px] w-full flex-grow ${
                            isSpecial ? "bg-secondary/20" : "bg-white/10"
                        }"></div>
                    </div>
                </div>
            `;

            let itemsHtml =
                '<div class="grid grid-cols-1 gap-y-0 text-left w-full">';

            if (hasSubcategories) {
                subcategories.forEach((sub: any) => {
                    itemsHtml += `
                        <div class="mb-12 last:mb-0">
                            <div class="border-b border-white/10 mb-2">
                                <h3 class="inline-block ${subTextColor} text-[13px] md:text-[15px] font-black uppercase tracking-[0.2em] px-4 py-2" style="background-color: ${subBgColor}">
                                    ${sub.name}
                                </h3>
                            </div>
                            <div class="flex flex-col gap-y-0">
                    `;

                    if (
                        sub.items &&
                        Array.isArray(sub.items) &&
                        sub.items.length > 0
                    ) {
                        sub.items.forEach((item: any) => {
                            itemsHtml += renderMenuItem(item);
                        });
                    } else {
                        itemsHtml +=
                            '<p class="text-[10px] text-gray-500 italic py-2">Keine Artikel</p>';
                    }

                    itemsHtml += `</div></div>`;
                });

                if (directItems.length > 0) {
                    itemsHtml += `
                        <div class="mb-12 last:mb-0">
                            <div class="border-b border-white/10 mb-2">
                                <h3 class="inline-block ${subTextColor} text-[13px] md:text-[15px] font-black uppercase tracking-[0.2em] px-4 py-2" style="background-color: ${subBgColor}">
                                    Weiteres
                                </h3>
                            </div>
                            <div class="flex flex-col gap-y-0">
                    `;
                    directItems.forEach((item: any) => {
                        itemsHtml += renderMenuItem(item);
                    });
                    itemsHtml += `</div></div>`;
                }
            } else {
                directItems.forEach((item: any) => {
                    itemsHtml += renderMenuItem(item);
                });
            }

            itemsHtml += "</div>";

            section.innerHTML = headerHtml + itemsHtml;
            container.appendChild(section);

            setTimeout(() => {
                section.classList.remove("opacity-0", "translate-y-8");
                section.classList.add("opacity-100", "translate-y-0");
            }, 50);
        });

        const legendHtml = `
            <div class="mt-20 p-6 md:p-8 border border-white/10 bg-white/[0.02] rounded-none opacity-0 transform translate-y-8 transition-all duration-700" id="allergens-legend">
                <h3 class="text-secondary text-sm font-bold uppercase tracking-widest mb-4">Allergene & Zusatzstoffe</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-2 text-[10px] text-gray-500 tracking-wider">
                    <div><span class="text-white font-bold">1</span> mit Farbstoff</div>
                    <div><span class="text-white font-bold">2</span> mit Konservierungsstoff</div>
                    <div><span class="text-white font-bold">3</span> mit Antioxidationsmittel</div>
                    <div><span class="text-white font-bold">4</span> mit Geschmacksverstärker</div>
                    <div><span class="text-white font-bold">5</span> geschwefelt</div>
                    <div><span class="text-white font-bold">6</span> geschwärzt</div>
                    <div><span class="text-white font-bold">7</span> gewachst</div>
                    <div><span class="text-white font-bold">8</span> mit Süßungsmitteln</div>
                    <div><span class="text-white font-bold">9</span> koffeinhaltig</div>
                    <div><span class="text-white font-bold">A</span> glutenhaltiges Getreide</div>
                    <div><span class="text-white font-bold">E</span> Erdnüsse</div>
                    <div><span class="text-white font-bold">G</span> Milch/Laktose</div>
                    <div><span class="text-white font-bold">H</span> Schalenfrüchte/Nüsse</div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML("beforeend", legendHtml);

        setTimeout(() => {
            const legend = document.getElementById("allergens-legend");
            if (legend) {
                legend.classList.remove("opacity-0", "translate-y-8");
                legend.classList.add("opacity-100", "translate-y-0");
            }
        }, data.length * 150 + 100);
    }

    function renderMenuItem(item: any) {
        const priceNum =
            typeof item.price === "number"
                ? item.price
                : parseFloat(item.price);
        const formattedPrice = priceNum.toFixed(2).replace(".", ",");

        const hasInfo = item.info || item.unit || item.allergens;
        const heightClass = hasInfo ? "py-2.5" : "py-2";
        const infoHtml = hasInfo
            ? `
            <div class="flex justify-between items-center text-[10px] md:text-[11px] text-gray-300 font-medium tracking-wide">
                <span class="opacity-90 flex items-center gap-2">
                    ${item.info || ""}
                    ${
                        item.allergens
                            ? `<span class="text-[9px] font-mono font-medium text-gray-400 bg-white/5 px-2 py-0.5 border border-white/10 tracking-widest leading-none" title="Allergene & Zusatzstoffe">${item.allergens}</span>`
                            : ""
                    }
                </span>
            </div>
        `
            : "";

        return `
            <div class="menu-item group flex flex-col gap-0 ${heightClass} border-b border-white/[0.05] last:border-0 hover:bg-white/[0.01] transition-all duration-300 rounded-none">
                <div class="flex justify-between items-baseline gap-4">
                    <h3 class="text-white text-[12px] md:text-[13px] font-bold group-hover:text-secondary transition-colors uppercase tracking-wider flex items-center gap-3">
                        ${item.name}
                    </h3>
                    <div class="flex items-baseline gap-2 text-secondary font-black whitespace-nowrap text-[12px] md:text-[13px]">
                        ${
                            item.unit
                                ? `<span class="text-[9px] md:text-[10px] text-gray-400 font-bold uppercase tracking-widest">${item.unit}</span>`
                                : ""
                        }
                        <span>${formattedPrice} €</span>
                    </div>
                </div>
                ${infoHtml}
            </div>
        `;
    }

    // Initialize
    loadMenu();

    // Header Scroll behavior — subtle shadow only, no size change
    window.addEventListener("scroll", () => {
        const header = document.getElementById("menu-header");
        if (header) {
            if (window.scrollY > 20) {
                header.style.boxShadow = "0 4px 20px rgba(0,0,0,0.6)";
            } else {
                header.style.boxShadow = "none";
            }
        }
    });
</script>

<style is:global>
    .special-category {
        box-shadow: 0 20px 50px -20px rgba(255, 224, 138, 0.05);
    }
    .menu-item {
        position: relative;
    }
</style>
