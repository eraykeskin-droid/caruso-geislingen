---
const defaultImages = [
    {
        id: "img-1",
        src: "/images/gallery/gallery-06.webp",
        alt: "Caruso Bar mit Premium-Spirituosen",
        span: "col-span-2",
    },
    {
        id: "img-2",
        src: "/images/gallery/gallery-04.webp",
        alt: "Premium Shisha mit Cocktail",
        span: "",
    },
    {
        id: "img-3",
        src: "/images/gallery/gallery-01.webp",
        alt: "Gemütliche Lounge-Ecke",
        span: "",
    },
    {
        id: "img-4",
        src: "/images/gallery/gallery-03.webp",
        alt: "Speisen, Cocktails und Pizza",
        span: "col-span-2",
    },
    {
        id: "img-5",
        src: "/images/gallery/gallery-05.webp",
        alt: "Handgefertigter Cocktail",
        span: "",
    },
    {
        id: "img-6",
        src: "/images/gallery/gallery-02.webp",
        alt: "Chesterfield Lounge-Bereich",
        span: "",
    },
    {
        id: "img-7",
        src: "/images/gallery/gallery-07.webp",
        alt: "Tropischer Cocktail mit Pizza",
        span: "",
    },
];
---

<section id="impressionen" class="py-24 px-6 bg-black border-t border-white/5">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-16">
            <h2 class="text-3xl md:text-5xl uppercase tracking-tighter mb-4">
                Impressionen
            </h2>
            <div class="h-1 w-20 bg-secondary mx-auto"></div>
        </div>

        <div
            id="gallery-grid"
            class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-3"
        >
            <!-- Rendered by client script -->
        </div>
    </div>
</section>

<!-- Lightbox -->
<div
    id="lightbox"
    class="fixed inset-0 z-[100] bg-black/98 hidden items-center justify-center p-6 cursor-pointer touch-none select-none"
>
    <button
        id="lightbox-close"
        class="absolute top-4 right-4 md:top-6 md:right-6 text-white/50 hover:text-white transition-colors z-10 p-4"
        aria-label="Schließen"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
        </svg>
    </button>
    <button
        id="lightbox-prev"
        class="absolute left-2 md:left-6 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-colors z-10 p-4"
        aria-label="Vorheriges Bild"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path d="m15 18-6-6 6-6"></path>
        </svg>
    </button>
    <button
        id="lightbox-next"
        class="absolute right-2 md:right-6 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-colors z-10 p-4"
        aria-label="Nächstes Bild"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path d="m9 18 6-6-6-6"></path>
        </svg>
    </button>
    <img
        id="lightbox-img"
        src=""
        alt=""
        class="max-w-full max-h-[85vh] object-contain touch-none select-none pointer-events-none"
    />
    <div
        id="lightbox-caption"
        class="absolute bottom-8 left-0 right-0 text-center text-white text-sm font-bold uppercase tracking-[0.2em] px-8 transition-opacity duration-300"
    >
    </div>
</div>

<script define:vars={{ defaultImages }}>
    const grid = document.getElementById("gallery-grid");
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const lightboxCaption = document.getElementById("lightbox-caption");
    const lightboxClose = document.getElementById("lightbox-close");
    const lightboxPrev = document.getElementById("lightbox-prev");
    const lightboxNext = document.getElementById("lightbox-next");

    const BASE_URL = "https://neu.caruso-geislingen.de";
    let images = defaultImages;
    let currentIndex = 0;

    function getFullSrc(src) {
        if (!src) return "";
        if (src.startsWith("http")) return src;
        // Always use remote path for gallery images as requested
        if (src.startsWith("/images/")) return BASE_URL + src;
        return src;
    }

    async function loadGallery() {
        try {
            const res = await fetch(
                "/api/get-website-data.php?t=" + Date.now()
            );
            const data = await res.json();
            if (data.success && data.images) {
                images = data.images;
            }
            renderGallery();
        } catch (err) {
            console.error("Error loading gallery:", err);
            renderGallery();
        }
    }

    function renderGallery() {
        if (!grid) return;
        grid.innerHTML = images
            .map(
                (img, i) => `
            <div class="gallery-item overflow-hidden cursor-pointer group relative ${
                img.span || ""
            }" data-index="${i}">
                <img
                    src="${getFullSrc(img.src)}"
                    alt="${img.alt}"
                    class="w-full h-48 md:h-64 object-cover transition-transform duration-700 group-hover:scale-110"
                    loading="lazy"
                />
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-500 flex items-end">
                    <p class="text-white text-[10px] uppercase tracking-widest font-bold px-4 pb-4 opacity-0 group-hover:opacity-100 transition-opacity duration-500 translate-y-4 group-hover:translate-y-0">
                        ${img.description || img.alt}
                    </p>
                </div>
            </div>
        `
            )
            .join("");

        // Attach click handlers
        grid.querySelectorAll(".gallery-item").forEach((item, i) => {
            item.addEventListener("click", () => openLightbox(i));
        });
    }

    let isAnimating = false;

    function openLightbox(index) {
        currentIndex = index;
        if (lightbox && lightboxImg) {
            const img = images[index];
            lightboxImg.src = getFullSrc(img.src);
            lightboxImg.alt = img.alt;
            if (lightboxCaption)
                lightboxCaption.textContent = img.description || img.alt;

            lightboxImg.style.transition = "none";
            lightboxImg.style.transform = "translate3d(0, 0, 0) scale(0.9)";
            lightboxImg.style.opacity = "0";
            if (lightboxCaption) {
                lightboxCaption.style.opacity = "0";
                lightboxCaption.style.transform = "translateY(20px)";
            }

            lightbox.classList.remove("hidden");
            lightbox.classList.add("flex");
            document.body.style.overflow = "hidden";

            requestAnimationFrame(() => {
                lightboxImg.style.transition =
                    "opacity 0.3s ease, transform 0.3s ease";
                lightboxImg.style.opacity = "1";
                lightboxImg.style.transform = "translate3d(0, 0, 0) scale(1)";
                if (lightboxCaption) {
                    lightboxCaption.style.transition =
                        "opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s";
                    lightboxCaption.style.opacity = "1";
                    lightboxCaption.style.transform = "translateY(0)";
                }
            });
        }
    }

    function closeLightbox() {
        if (!lightbox) return;

        lightboxImg.style.transition =
            "opacity 0.25s ease, transform 0.25s ease";
        lightboxImg.style.opacity = "0";
        lightboxImg.style.transform = "translate3d(0, 0, 0) scale(0.9)";

        if (lightboxCaption) {
            lightboxCaption.style.transition = "opacity 0.2s ease";
            lightboxCaption.style.opacity = "0";
        }

        setTimeout(() => {
            lightbox.classList.add("hidden");
            lightbox.classList.remove("flex");
            document.body.style.overflow = "";
        }, 250);
    }

    function navigate(direction) {
        if (isAnimating || !lightboxImg) return;
        isAnimating = true;
        lightboxImg.style.transition =
            "transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease";
        lightboxImg.style.transform = `translate3d(${
            direction * -100
        }vw, 0, 0) scale(1)`;
        if (lightboxCaption) lightboxCaption.style.opacity = "0";

        setTimeout(() => {
            currentIndex =
                (currentIndex + direction + images.length) % images.length;
            const img = images[currentIndex];
            lightboxImg.src = getFullSrc(img.src);
            lightboxImg.alt = img.alt;
            if (lightboxCaption)
                lightboxCaption.textContent = img.description || img.alt;

            lightboxImg.style.transition = "none";
            lightboxImg.style.transform = `translate3d(${
                direction * 100
            }vw, 0, 0) scale(1)`;

            void lightboxImg.offsetWidth;

            lightboxImg.style.transition =
                "transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease";
            lightboxImg.style.transform = "translate3d(0, 0, 0) scale(1)";
            if (lightboxCaption) {
                lightboxCaption.style.transition = "opacity 0.3s ease 0.1s";
                lightboxCaption.style.opacity = "1";
            }

            setTimeout(() => {
                isAnimating = false;
            }, 300);
        }, 300);
    }

    lightboxClose?.addEventListener("click", (e) => {
        e.stopPropagation();
        closeLightbox();
    });
    lightboxPrev?.addEventListener("click", (e) => {
        e.stopPropagation();
        navigate(-1);
    });
    lightboxNext?.addEventListener("click", (e) => {
        e.stopPropagation();
        navigate(1);
    });
    lightbox?.addEventListener("click", (e) => {
        if (e.target === lightbox) closeLightbox();
    });

    document.addEventListener("keydown", (e) => {
        if (!lightbox?.classList.contains("flex")) return;
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") navigate(-1);
        if (e.key === "ArrowRight") navigate(1);
    });

    // Touch swipe logic
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;

    lightbox?.addEventListener(
        "touchstart",
        (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        },
        { passive: true }
    );

    lightbox?.addEventListener(
        "touchend",
        (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        },
        { passive: true }
    );

    function handleSwipe() {
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;

        if (Math.abs(diffY) > Math.abs(diffX) && diffY > 50) {
            closeLightbox();
            return;
        }

        if (diffX < -50) navigate(1);
        if (diffX > 50) navigate(-1);
    }

    loadGallery();
</script>
